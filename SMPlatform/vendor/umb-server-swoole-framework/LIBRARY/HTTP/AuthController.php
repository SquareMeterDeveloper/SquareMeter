<?php
/**
 * Project: UmbServerSwooleFramework
 * File: AuthController.php
 * Create: 2018/3/20
 * Author: Hugh.Lee
 * Email: umbrellahughlee@gmail.com
 * Copyright: Umbrella Inc.
 */

namespace UmbServer\SwooleFramework\LIBRARY\HTTP;

use UmbServer\SwooleFramework\LIBRARY\UTIL\Algorithm;

/**
 * 认证控制器类
 * Class AuthController
 * @package UmbServer\SwooleFramework\LIBRARY\HTTP
 */
class AuthController extends Controller
{
    private $_login_user; //登陆用户实例
    private $_user_class_path; //用户类名

    public function __construct( Request $request, $user_class_path )
    {
        parent::__construct( $request );
        $this->_user_class_path = $user_class_path;
    }

    /**
     * 重写前置方法
     * @return bool
     */
    public function _before(): bool
    {
        $api_key = $this->HEADER[ 'api_key' ];
        $user = call_user_func( [ $this->_user_class_path, '_getByApiKey' ] );


        if ( isset( $this->FILES ) ) {
            $this->_login_user = $user;
            return true;
        }

        //检查signature
        $signature = $this->HEADER[ 'signature' ];
        $path = $this->REQUEST->server[ 'request_uri' ];
        $api_secret = $account_data->getAttribute( 'api_secret' );
        $verb = $this->REQUEST->server[ 'request_method' ];
        $payload = $verb . $path;

        if ( !empty( $this->$verb ) ) {
            //JSON_UNESCAPED_UNICODE用于处理中文问题
            $params_encode = json_encode( $this->$verb, JSON_UNESCAPED_UNICODE );
            $payload .= $params_encode;
        }

        // var_dump($this->REQUEST->rawContent());
        echo 'Expire Preload String: ' . $payload . PHP_EOL;
        $expire_signature = Algorithm::hmacSha256( $payload, $api_secret );
        echo 'Signature: ' . $signature . PHP_EOL;
        echo 'Expire: ' . $expire_signature . PHP_EOL;
//        if ( $signature != $expire_signature ) {
//            throw new Error( Error::API_AUTH_FAIL );
//        }
        $account_manager = new AccountManager( $account_data->id );
        $this->account_manager = $account_manager;
        return true;
    }

    public function _after(): bool
    {
        parent::_after(); // TODO: Change the autogenerated stub
    }
}